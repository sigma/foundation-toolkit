Constants = function() {};
Constants.I1 = "1";
Constants.I2 = "2";
Constants.E1 = "3";
Constants.M2 = "4";
Constants.F2 = "5";
Constants.SF = "6";
Constants.MU = "7";
Constants.E2 = "8";
Constants.M1 = "9";
Constants.F1 = "10";
Constants.I3 = "11";
Constants.deleteImg = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAAABGdBTUEAAK%2FINwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAAYUExURZlmZv%2BZM%2F9mAMwzM8wAAP8AAJkAAAAAAJHQzOoAAAAIdFJOU%2F%2F%2F%2F%2F%2F%2F%2F%2F8A3oO9WQAAAJFJREFUeNpiYEcDAAHEwM7AwgDnsbCzAwQQAzsLIysblAuiAQIIKMvCChEB89kBAgisnAUkAuGzAwQQRD9QBMpnBwggqIEsMHPYAQIIrgImAhBACDOgIgABxIBQDyEBAggowMzEAlHNCiIAAoiBnRnuMLAIQAABBeB8MAAIIKAWJD5QCUAAMaD7FiCAMAQAAgwAYLoGdQu5RxIAAAAASUVORK5CYII%3D";
Constants.redLeader = "data:image/gif;base64,R0lGODlhFAAUAKUgAAgAACAAADQAADwAAEAAABUAtA4AzCUAnAsA5GAAAAYA/EEAhIAAAGwATJAAAKAAAKgAAK8BAcAAAMwFAOAAAP8BAfARAP8REf8ZGf8pKf9JSfxS/v95ef+B9/+pqf+t+gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAACAALAAAAAAUABQAAAaCQJBwSCRWikUJA0nJIImOJ0ghFVKFm83CWqhehhdNQhiBVB1dBYET+BQGVeFgMWAAOoNGnFgoHDxXe0IFBgsFW4JCBwUWDQeJIAITCgYNeokYDQkJjpAXCAgKCgiQCQZdBgaQAAV6i5AgD2MMD7CtIKewliALl4kJBCCbsBlLDE5IQQA7";
Constants.hLine = "data:image/gif;base64,R0lGODlhUAACAIcAAP%2F%2F%2FwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAAAAP8ALAAAAABQAAIAAAgXAAEIHEiwoMGDCBMqXMiwocOHECMeDAgAOw%3D%3D";
Constants.vLine = "data:image/gif;base64,R0lGODlhAgBkAIcAAP%2F%2F%2FwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAAAAP8ALAAAAAACAGQAAAgZAAEIHEiwoMGDCBMqXMiwocOHECNKnKgwIAA7";
Constants.greenBG = "data:image/gif;base64,R0lGODlhMgAyAIcAAIj%2FJQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAAAAP8ALAAAAAAyADIAAAhTAAEIHEiwoMGDCBMqXMiwocOHECNKnEixosWLGDNq3Mixo8ePIEOKHEmypMmTKFOqXMmypcuXMGPKnEmzps2bOHPq3Mmzp8%2BfQIMKHUq0qNGHAQEAOw%3D%3D";


function Utils() {

    this.clearLeaders = function() {
        db.execute("delete from Leaders where account = ?", [this.getOption("account")]);
    };

    this.getCookieVal = function(offset) {
        var endstr = document.cookie.indexOf(";", offset);
        if (endstr == -1)
            endstr = document.cookie.length;
        return unescape(document.cookie.substring(offset, endstr));
    };

    this.getCookieByName = function(name) {
        var arg = name + "=";
        var alen = arg.length;
        var clen = document.cookie.length;
        var i = 0;

        while (i < clen) {
            var j = i + alen;
            if (document.cookie.substring(i, j) == arg)
                return utils.getCookieVal(j);
            i = document.cookie.indexOf(" ",i) + 1;
            if (i == 0)
                break;
        }

        return null;
    };

    this.setCookie = function(name, value, domain, path) {
        document.cookie = name + "=" + escape(value) + ((path==null) ? "" : ("; path=" + path)) + ((domain==null) ? "" : ("; domain=" + domain));
    };

    this.getOption = function(key, def) {
        var rs = db.execute("select value from Options where name = ?;", [key]);
        while (rs.isValidRow()) {
            def = rs.field(0);
            rs.next();
        }
        rs.close();
        return def;
    };

    this.setOption = function(key, value) {
        db.execute("replace into Options values (?, ?)", [key, value]);
    };

    this.calcBestOffer = function(props) {
        return "fer-1|etain-1";
    }

    this.leaderColors = ["white", "green", "yellow", "red", "blue", "violet"];

    this.normalizeLeaderName = function(leader) {
        var index = leader.lastIndexOf(" (");
        if (index == -1)
            return leader;
        else {
            leader = leader.slice(0,index) + leader.slice(index + 1);
            return leader;
        }
    };

    this.getLeaderColor = function(leader) {
        leader = this.normalizeLeaderName(leader);
        var rs = db.execute("select color from Leaders_color where name = ? and account = ?;", [leader, this.getOption("account")]);
        var res = null;
        if (rs.isValidRow()) {
            res = rs.field(0);
        }
        rs.close();
        return res;
    };

    this.getNextLeaderColor = function(color) {
        for (var i = 0; i < this.leaderColors.length; i++) {
            if (this.leaderColors[i] == color)
                return this.leaderColors[((i+1) % this.leaderColors.length)];
        }
    };

    this.recordLeaderColor = function(leader,color) {
        leader = this.normalizeLeaderName(leader);
        db.execute("update Leaders_color set color = ? where name = ? and account = ?;", [color, leader, this.getOption("account")]);
    };

    this.setLeaderColor = function(index,color) {
        var polTabChildren = document.getElementById("politique").childNodes;
        var j = 0;
        var leader;

        for (var i = 0; i < polTabChildren.length; i++) {
            if (polTabChildren[i].nodeName == "#text" &&
                polTabChildren[i].nodeValue.match(" est pr.sent ici !")) {

                if (j == index) {
                    leader = polTabChildren[i-1];
                    break;
                }
                else
                    j++;
            }
        }
        leader.setAttribute("style", "color: " + color);
        leader.setAttribute('href', 'javascript:details_setLeaderColor(' + index + ',"' + this.getNextLeaderColor(color) + '")');

        this.recordLeaderColor(leader.firstChild.nodeValue, color);
    };

}

function installHacks() {
    var mapping = {"menu.php": "menu",
                   "stats.php": "stats",
                   "map.php": "map",
                   "messages.php": "messages",
                   "detail.php": "detail",
                   "leader.php": "leader"};

    for (var page in mapping) {
        if (location.pathname.search(page) != -1) {
            wpMgr.loadLib(mapping[page]);
        }
    }
}

utils = new Utils();
db.open("fondation_offline");

installHacks();
